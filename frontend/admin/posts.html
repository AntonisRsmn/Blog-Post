<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>All Posts</title>
  <link rel="stylesheet" href="../css/global.css" />
  <link rel="stylesheet" href="../css/admin.css" />

  <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/image@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/embed@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@latest"></script>
</head>
<body>

<header>
  <div class="header-inner">
    <a href="/" class="logo">Rusman</a>
    <button type="button" id="mobile-menu-toggle" class="mobile-menu-toggle" aria-label="Open menu" aria-controls="mobile-sidebar" aria-expanded="false">☰</button>
    <nav>
      <a href="/" class="nav-link">Home</a>
      <a href="/admin/dashboard.html" class="nav-link" data-staff-only hidden>Dashboard</a>
      <a href="/admin/analytics.html" class="nav-link" data-staff-only hidden>Analytics</a>
      <a href="/admin/vitals.html" class="nav-link" data-staff-only hidden>Vitals</a>
      <a href="/admin/staff.html" class="nav-link" data-staff-only hidden>Staff Access</a>
      <a href="/admin/profile.html" class="nav-link" data-auth-link>Profile</a>
      <button id="theme-toggle"></button>
    </nav>
  </div>
</header>

<div id="mobile-sidebar-backdrop" class="mobile-sidebar-backdrop" hidden></div>
<aside id="mobile-sidebar" class="mobile-sidebar" aria-label="Mobile navigation" aria-hidden="true">
  <div class="mobile-sidebar-head">
    <strong>Menu</strong>
    <button type="button" id="mobile-sidebar-close" class="mobile-sidebar-close" aria-label="Close menu">✕</button>
  </div>
  <nav class="mobile-sidebar-nav">
    <a href="/" class="nav-link">Home</a>
    <a href="/admin/dashboard.html" class="nav-link" data-staff-only hidden>Dashboard</a>
    <a href="/admin/analytics.html" class="nav-link" data-staff-only hidden>Analytics</a>
    <a href="/admin/vitals.html" class="nav-link" data-staff-only hidden>Vitals</a>
    <a href="/admin/staff.html" class="nav-link" data-staff-only hidden>Staff Access</a>
    <a href="/admin/login.html" class="nav-link" data-auth-link>Login</a>
    <div class="mobile-theme-row">
      <span>Theme</span>
      <button type="button" id="mobile-theme-toggle" class="mobile-theme-switch" aria-label="Toggle theme"></button>
    </div>
  </nav>
</aside>

<main>
  <div class="admin-container">
    <div class="admin-page-head">
      <h1 class="admin-title">All Published Posts</h1>
      <p class="admin-subtitle">Search and manage all posts in one place.</p>
    </div>

    <div id="status" class="admin-status" role="status" aria-live="polite"></div>

    <div class="admin-section">
      <div class="latest-posts-head">
        <div class="latest-posts-head-copy">
          <h2>Posts</h2>
          <p class="release-manager-hint">Search and manage all posts in one place.</p>
        </div>
        <button type="button" class="admin-link-btn admin-link-btn-primary" onclick="openCreatePostModal()">New Post</button>
      </div>

      <div class="posts-search-wrap">
        <input id="posts-search" type="text" placeholder="Search by title or slug..." aria-label="Search published posts" />
      </div>

      <ul id="posts" class="posts-list"></ul>

      <div class="posts-list-actions" style="justify-content: flex-start;">
        <a href="/admin/dashboard.html" class="admin-link-btn">Back to dashboard</a>
      </div>
    </div>
  </div>

  <div id="post-edit-overlay" class="post-edit-overlay" hidden>
    <div class="post-edit-modal" role="dialog" aria-modal="true" aria-labelledby="post-edit-title">
      <div class="post-edit-head">
        <h2 id="post-edit-title">New Post</h2>
        <button type="button" id="post-edit-close" class="secondary">Close</button>
      </div>

      <form id="postEditForm" class="post-edit-form">
        <input type="hidden" id="post-edit-id" />

        <div class="form-group">
          <label for="post-edit-title-input">Title</label>
          <input id="post-edit-title-input" type="text" placeholder="Post Title" required />
        </div>

        <div class="form-group">
          <label for="post-edit-slug">Slug</label>
          <input id="post-edit-slug" type="text" placeholder="Slug ( Auto Generated)" required />
        </div>

        <div class="form-group">
          <label for="post-edit-categories">Categories</label>
          <input id="post-edit-categories" type="text" placeholder="Tech, AI, Gaming" />
        </div>

        <div class="form-group">
          <label>Content</label>
          <div id="posts-editor"></div>
        </div>

        <div class="form-group">
          <label for="post-edit-summary">SEO Meta Description</label>
          <textarea id="post-edit-summary" rows="3" maxlength="220" placeholder="Short search/snippet description (max 220 characters)"></textarea>
        </div>

        <div class="form-group">
          <label>Internal link suggestions</label>
          <p class="release-manager-hint">Suggested existing posts to link from this article.</p>
          <ul id="post-edit-link-suggestions" class="posts-list" style="margin-top: 8px;"></ul>
        </div>

        <div class="post-edit-actions">
          <button type="submit" id="post-edit-save">Create Post</button>
          <button type="button" id="post-edit-cancel" class="secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</main>

<footer class="site-footer">
  <div class="container footer-grid">
    <div class="footer-left">
      <div class="brand-small">
        Antonios <span style="color:var(--accent)">Rusman</span>
      </div>
      <div class="muted small">© <span id="year"></span> <a href="https://rusman.gr" target="_blank" rel="noopener">Antonios Rusman</a> — All rights reserved.</div>
    </div>

    <div class="footer-center">
      <nav class="footer-nav" aria-label="Footer navigation">
        <a href="/tos.html">Terms of Service</a>
        <a href="/privacy.html">Privacy Policy</a>
      </nav>
    </div>

    <div class="footer-right" aria-hidden="false">
      <div class="social" role="list">
        <a class="social-link" href="mailto:info@rusman.gr" aria-label="Email" role="listitem">
          <svg viewBox="0 0 24 24" fill="none" width="18" height="18" aria-hidden="true">
            <path d="M3 6.5h18v11a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-11z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M21 6.5L12 13 3 6.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>

        <a class="social-link" href="https://github.com/AntonisRsmn" target="_blank" rel="noopener" aria-label="GitHub" role="listitem">
          <svg viewBox="0 0 24 24" fill="none" width="18" height="18" aria-hidden="true">
            <path d="M12 2C7.58 2 4 5.58 4 10c0 3.54 2.29 6.54 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82A7.56 7.56 0 0 1 12 6.8c.68.003 1.36.092 2 .27 1.53-1.03 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 20 10c0-4.42-3.58-8-8-8z" fill="currentColor"/>
          </svg>
        </a>

        <a class="social-link" href="https://www.linkedin.com/in/antonis-rusman-a46424319/" target="_blank" rel="noopener" aria-label="LinkedIn" role="listitem">
          <svg viewBox="0 0 24 24" fill="none" width="18" height="18" aria-hidden="true">
            <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="1.6"/>
            <path d="M7.5 11.5v5M7.5 8.5v.01M12 16.5v-4c0-1 .6-1.5 1.4-1.5.8 0 1.6.5 1.6 1.6v3.9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>

        <a class="social-link" href="https://instagram.com/_.rusman._" target="_blank" rel="noopener" aria-label="Instagram" role="listitem">
          <svg viewBox="0 0 24 24" fill="none" width="18" height="18" aria-hidden="true">
            <rect x="3.5" y="3.5" width="17" height="17" rx="4" stroke="currentColor" stroke-width="1.6"/>
            <path d="M12 8.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="17.5" cy="6.5" r="0.6" fill="currentColor"/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>

<script src="../js/theme.js"></script>
<script>
document.getElementById('year').textContent = new Date().getFullYear();

const statusEl = document.getElementById("status");
let allPosts = [];
let postEditor = null;
let isSlugManuallyEdited = false;

const editOverlay = document.getElementById("post-edit-overlay");
const editForm = document.getElementById("postEditForm");
const editCloseButton = document.getElementById("post-edit-close");
const editCancelButton = document.getElementById("post-edit-cancel");
const editModalTitle = document.getElementById("post-edit-title");
const editTitleInput = document.getElementById("post-edit-title-input");
const editSlugInput = document.getElementById("post-edit-slug");
const editCategoriesInput = document.getElementById("post-edit-categories");
const editIdInput = document.getElementById("post-edit-id");
const editSummaryInput = document.getElementById("post-edit-summary");
const postEditLinkSuggestionsEl = document.getElementById("post-edit-link-suggestions");
let statusHideTimer = null;
const DEFAULT_POST_IMAGE = "/assets/default-post.svg";
const POSTS_EDITOR_DRAFT_PREFIX = "posts-editor-draft-v1:";
let postsDraftTimer = null;
let postsDraftRestoreInProgress = false;

function getPostsDraftContextId() {
  const id = String(editIdInput?.value || "").trim();
  return id || "new";
}

function getPostsDraftKey(contextId = getPostsDraftContextId()) {
  return `${POSTS_EDITOR_DRAFT_PREFIX}${contextId}`;
}

function parsePostsDraft(raw) {
  try {
    const parsed = JSON.parse(String(raw || ""));
    if (!parsed || typeof parsed !== "object") return null;
    return parsed;
  } catch {
    return null;
  }
}

function getPostsDraftByContext(contextId = getPostsDraftContextId()) {
  try {
    const raw = localStorage.getItem(getPostsDraftKey(contextId));
    return parsePostsDraft(raw);
  } catch {
    return null;
  }
}

function hasPostsDraftContent(payload) {
  const draft = payload && typeof payload === "object" ? payload : {};
  const hasTitle = String(draft.title || "").trim().length > 0;
  const hasSlug = String(draft.slug || "").trim().length > 0;
  const hasCategories = String(draft.categories || "").trim().length > 0;
  const hasSummary = String(draft.metaDescription || "").trim().length > 0;
  const hasBlocks = Array.isArray(draft.content) && draft.content.length > 0;
  return hasTitle || hasSlug || hasCategories || hasSummary || hasBlocks;
}

function toComparablePostsCategories(value) {
  return parseCategories(value)
    .map(item => String(item || "").trim())
    .filter(Boolean)
    .sort((a, b) => a.localeCompare(b));
}

function toComparablePostsBlocks(blocks) {
  return JSON.stringify(Array.isArray(blocks) ? blocks : []);
}

function isPostsDraftDifferentFromBase(draft, baseState) {
  const base = baseState && typeof baseState === "object" ? baseState : null;
  if (!base) return true;

  const draftTitle = String(draft?.title || "").trim();
  const baseTitle = String(base?.title || "").trim();
  if (draftTitle !== baseTitle) return true;

  const draftSlug = String(draft?.slug || "").trim();
  const baseSlug = String(base?.slug || "").trim();
  if (draftSlug !== baseSlug) return true;

  const draftSummary = String(draft?.metaDescription || "").trim();
  const baseSummary = String(base?.metaDescription || "").trim();
  if (draftSummary !== baseSummary) return true;

  const draftCategories = JSON.stringify(toComparablePostsCategories(draft?.categories || ""));
  const baseCategories = JSON.stringify(toComparablePostsCategories(base?.categories || ""));
  if (draftCategories !== baseCategories) return true;

  const draftBlocks = toComparablePostsBlocks(draft?.content);
  const baseBlocks = toComparablePostsBlocks(base?.content);
  return draftBlocks !== baseBlocks;
}

function removePostsDraft(contextId = getPostsDraftContextId()) {
  try {
    localStorage.removeItem(getPostsDraftKey(contextId));
  } catch {
  }
}

async function savePostsEditorDraft() {
  if (postsDraftRestoreInProgress) return;
  if (!editOverlay || editOverlay.hidden) return;
  if (!postEditor) return;

  let blocks = [];
  try {
    const payload = await postEditor.save();
    blocks = Array.isArray(payload?.blocks) ? payload.blocks : [];
  } catch {
    return;
  }

  const contextId = getPostsDraftContextId();
  const draft = {
    contextId,
    title: String(editTitleInput?.value || ""),
    slug: String(editSlugInput?.value || ""),
    categories: String(editCategoriesInput?.value || ""),
    metaDescription: String(editSummaryInput?.value || ""),
    content: blocks,
    updatedAt: new Date().toISOString()
  };

  if (!hasPostsDraftContent(draft)) {
    removePostsDraft(contextId);
    return;
  }

  try {
    localStorage.setItem(getPostsDraftKey(contextId), JSON.stringify(draft));
  } catch {
  }
}

function schedulePostsEditorDraftAutosave(delayMs = 1200) {
  if (postsDraftRestoreInProgress) return;
  if (postsDraftTimer) {
    clearTimeout(postsDraftTimer);
  }

  postsDraftTimer = setTimeout(() => {
    postsDraftTimer = null;
    savePostsEditorDraft();
  }, Math.max(350, Number(delayMs) || 1200));
}

async function maybeRestorePostsEditorDraft(contextId = getPostsDraftContextId(), baseState = null) {
  const draft = getPostsDraftByContext(contextId);
  if (!draft || !hasPostsDraftContent(draft)) return;
  if (!isPostsDraftDifferentFromBase(draft, baseState)) return;

  const draftDate = draft.updatedAt ? new Date(draft.updatedAt) : null;
  const draftLabel = draftDate && !Number.isNaN(draftDate.getTime())
    ? draftDate.toLocaleString()
    : "recent session";
  const promptText = `Unsaved draft found (${draftLabel}). Restore it?`;
  const shouldRestore = window.showAppConfirm
    ? await window.showAppConfirm(promptText, {
      title: "Restore draft",
      confirmText: "Restore",
      cancelText: "Cancel"
    })
    : window.confirm(promptText);
  if (!shouldRestore) return;

  postsDraftRestoreInProgress = true;
  try {
    if (editTitleInput) editTitleInput.value = String(draft.title || "");
    if (editSlugInput) editSlugInput.value = String(draft.slug || "");
    if (editCategoriesInput) editCategoriesInput.value = String(draft.categories || "");
    if (editSummaryInput) editSummaryInput.value = String(draft.metaDescription || "");
    if (postEditor) {
      await postEditor.render({ blocks: Array.isArray(draft.content) ? draft.content : [] });
    }
    showStatus("Draft restored.", "success");
  } finally {
    postsDraftRestoreInProgress = false;
  }
}

function showStatus(message, type) {
  if (!statusEl) return;
  if (statusHideTimer) {
    clearTimeout(statusHideTimer);
    statusHideTimer = null;
  }
  statusEl.textContent = message;
  statusEl.classList.remove("success", "error", "deleted", "show");
  if (type) statusEl.classList.add(type);
  statusEl.classList.add("show");

  statusHideTimer = setTimeout(() => {
    statusEl.textContent = "";
    statusEl.classList.remove("success", "error", "deleted", "show");
    statusHideTimer = null;
  }, 5000);
}

function normalizePostsSearch(value) {
  return String(value || "").toLowerCase().trim();
}

function toSuggestionTerms(value) {
  return String(value || "")
    .toLowerCase()
    .replace(/[^\p{L}\p{N}\s-]/gu, " ")
    .replace(/[-_]+/g, " ")
    .split(/\s+/)
    .map(term => term.trim())
    .filter(term => term.length >= 3);
}

function renderPostEditLinkSuggestions() {
  if (!postEditLinkSuggestionsEl) return;

  const title = String(editTitleInput?.value || "");
  const slug = String(editSlugInput?.value || "");
  const categories = String(editCategoriesInput?.value || "");
  const currentId = String(editIdInput?.value || "").trim();
  const terms = [...new Set([
    ...toSuggestionTerms(title),
    ...toSuggestionTerms(slug),
    ...toSuggestionTerms(categories)
  ])];

  const candidates = (Array.isArray(allPosts) ? allPosts : [])
    .filter(post => String(post?._id || "") !== currentId)
    .map(post => {
      const haystack = normalizePostsSearch(`${post?.title || ""} ${post?.slug || ""} ${(post?.categories || []).join(" ")}`);
      const score = terms.reduce((sum, term) => sum + (haystack.includes(term) ? 1 : 0), 0);
      return { post, score };
    })
    .filter(item => item.score > 0)
    .sort((a, b) => {
      if (b.score !== a.score) return b.score - a.score;
      return new Date(b.post?.createdAt || 0) - new Date(a.post?.createdAt || 0);
    })
    .slice(0, 5);

  postEditLinkSuggestionsEl.innerHTML = "";

  if (!terms.length) {
    postEditLinkSuggestionsEl.innerHTML = '<li style="padding: 10px 12px; color: var(--text-muted);">Start typing title/categories to get suggestions.</li>';
    return;
  }

  if (!candidates.length) {
    postEditLinkSuggestionsEl.innerHTML = '<li style="padding: 10px 12px; color: var(--text-muted);">No strong matches yet.</li>';
    return;
  }

  candidates.forEach(({ post, score }) => {
    const li = document.createElement("li");
    li.className = "post-item";
    const safePostId = encodeURIComponent(post?._id || "");
    const safeSlug = encodeURIComponent(post?.slug || "");
    const href = `/post.html?id=${safePostId}${safeSlug ? `&slug=${safeSlug}` : ""}`;
    li.innerHTML = `
      <a class="post-item-title" href="${href}" target="_blank" rel="noopener">${post?.title || "Untitled"}</a>
      <span class="release-event-date">/${post?.slug || ""} • relevance ${score}</span>
    `;
    postEditLinkSuggestionsEl.appendChild(li);
  });
}

function toSlug(value) {
  return String(value || "")
    .toLowerCase()
    .trim()
    .replace(/[^\p{L}\p{N}\s-]/gu, "")
    .replace(/\s+/g, "-")
    .replace(/-+/g, "-");
}

function parseCategories(value) {
  const normalized = String(value || "")
    .split(",")
    .map(item => item.replace(/\s+/g, " ").trim().toUpperCase())
    .filter(Boolean);

  return [...new Set(normalized)];
}

function collectTextValues(value, result) {
  if (typeof value === "string") {
    result.push(value.replace(/<[^>]*>/g, " "));
    return;
  }

  if (Array.isArray(value)) {
    value.forEach(item => collectTextValues(item, result));
    return;
  }

  if (value && typeof value === "object") {
    Object.values(value).forEach(item => collectTextValues(item, result));
  }
}

function generateSummaryFromBlocks(blocks) {
  const values = [];
  collectTextValues(blocks, values);
  const normalized = values
    .join(" ")
    .replace(/\s+/g, " ")
    .trim();

  if (!normalized) return "";
  if (normalized.length <= 180) return normalized;
  return `${normalized.slice(0, 177).trimEnd()}...`;
}

function extractImageAltText(block) {
  if (!block || block.type !== "image") return "";
  const rawAlt = String(
    block?.data?.alt ||
    block?.data?.caption ||
    block?.data?.file?.alt ||
    ""
  );
  return rawAlt.replace(/<[^>]*>/g, " ").replace(/\s+/g, " ").trim();
}

function normalizeImageAltInBlocks(blocks) {
  const list = Array.isArray(blocks) ? blocks : [];
  return list.map((block) => {
    if (!block || block.type !== "image") return block;
    const alt = extractImageAltText(block);
    return {
      ...block,
      data: {
        ...(block.data || {}),
        alt
      }
    };
  });
}

function getMissingImageAltCount(blocks) {
  const list = Array.isArray(blocks) ? blocks : [];
  return list
    .filter(block => block?.type === "image")
    .filter(block => !extractImageAltText(block))
    .length;
}

async function confirmImageAltReminder(blocks) {
  const missingCount = getMissingImageAltCount(blocks);
  if (!missingCount) return true;

  const noun = missingCount === 1 ? "image is" : "images are";
  const promptText = `${missingCount} ${noun} missing alt text. Add short descriptive alt text to improve SEO and accessibility.`;
  if (window.showAppConfirm) {
    return window.showAppConfirm(promptText, {
      title: "Alt-text reminder",
      confirmText: "Publish anyway",
      cancelText: "Review images"
    });
  }

  return window.confirm(`${promptText} Continue publishing?`);
}

async function ensurePostEditor() {
  if (postEditor) return postEditor;

  postEditor = new EditorJS({
    holder: "posts-editor",
    async onChange() {
      schedulePostsEditorDraftAutosave();
    },
    tools: {
      paragraph: {
        class: Paragraph,
        inlineToolbar: true
      },
      image: {
        class: ImageTool,
        config: {
          uploader: {
            uploadByFile(file) {
              const form = new FormData();
              form.append("image", file);

              return fetch("/api/upload", {
                method: "POST",
                body: form
              })
                .then(res => res.json())
                .then(data => ({
                  success: 1,
                  file: { url: data.url }
                }));
            }
          }
        }
      },
      embed: {
        class: Embed,
        config: {
          services: {
            youtube: true,
            twitter: true
          }
        }
      },
      quote: {
        class: Quote,
        inlineToolbar: true
      }
    }
  });

  await postEditor.isReady;
  return postEditor;
}

function openEditModal() {
  if (!editOverlay) return;
  editOverlay.hidden = false;
  document.body.style.overflow = "hidden";
}

async function closeEditModal() {
  if (!editOverlay) return;
  if (postsDraftTimer) {
    clearTimeout(postsDraftTimer);
    postsDraftTimer = null;
  }
  editOverlay.hidden = true;
  document.body.style.overflow = "";
  editForm?.reset();
  editIdInput.value = "";
  isSlugManuallyEdited = false;

  if (postEditor) {
    await postEditor.clear();
  }

  if (editModalTitle) editModalTitle.textContent = "New Post";
  const saveButton = document.getElementById("post-edit-save");
  if (saveButton) saveButton.textContent = "Create Post";
  if (editCancelButton) editCancelButton.textContent = "Cancel";
}

async function cancelEditAndDiscardDraft() {
  if (postsDraftTimer) {
    clearTimeout(postsDraftTimer);
    postsDraftTimer = null;
  }
  const contextId = getPostsDraftContextId();
  removePostsDraft(contextId);
  await closeEditModal();
}

async function openCreatePostModal() {
  await ensurePostEditor();
  await closeEditModal();
  openEditModal();
  await maybeRestorePostsEditorDraft("new");
  renderPostEditLinkSuggestions();
}

async function ensureStaffAccess() {
  const res = await fetch("/api/auth/profile");
  if (!res.ok) {
    window.location.href = "/no-access.html";
    return false;
  }

  const profile = await res.json();
  if (profile.role !== "admin" && profile.role !== "staff") {
    window.location.href = "/no-access.html";
    return false;
  }

  return true;
}

function getFilteredPosts() {
  const query = normalizePostsSearch(document.getElementById("posts-search")?.value);
  if (!query) return allPosts;

  return allPosts.filter(post => {
    const title = normalizePostsSearch(post.title);
    const slug = normalizePostsSearch(post.slug);
    return title.includes(query) || slug.includes(query);
  });
}

function getPostImageUrl(post) {
  if (post?.thumbnailUrl) return post.thumbnailUrl;
  if (!Array.isArray(post?.content)) return "";
  const imageBlock = post.content.find(block => block?.type === "image");
  const resolved = imageBlock
    ? (imageBlock?.data?.file?.url || imageBlock?.data?.url || imageBlock?.data?.file || "")
    : "";
  return resolved || DEFAULT_POST_IMAGE;
}

function renderPostsList() {
  const list = document.getElementById("posts");
  if (!list) return;
  list.innerHTML = "";

  if (!allPosts.length) {
    list.innerHTML = '<li style="padding: 16px; text-align: center; color: var(--text-muted);">No posts yet</li>';
    return;
  }

  const filtered = getFilteredPosts();

  if (!filtered.length) {
    list.innerHTML = '<li style="padding: 16px; text-align: center; color: var(--text-muted);">No posts match your search</li>';
    return;
  }

  filtered.forEach(post => {
    const li = document.createElement("li");
    li.className = "post-item posts-page-item";
    const imageUrl = getPostImageUrl(post);
    const safePostId = encodeURIComponent(post._id || "");
    const safeSlug = encodeURIComponent(post.slug || "");
    const postUrl = `/post.html?id=${safePostId}${safeSlug ? `&slug=${safeSlug}` : ""}`;
    li.innerHTML = `
      <div class="posts-page-main">
        <a href="${postUrl}" aria-label="Open ${post.title}">
          ${imageUrl
            ? `<img src="${imageUrl}" alt="${post.title}" class="posts-page-thumb" />`
            : '<div class="posts-page-thumb posts-page-thumb-placeholder" aria-hidden="true"></div>'}
        </a>
        <div class="posts-page-text">
          <span class="post-item-title">${post.title}</span>
          <span class="release-event-date">/${post.slug}</span>
        </div>
      </div>
      <div class="post-item-actions">
        <button class="secondary" onclick="editPostById(decodeURIComponent('${safePostId}'))">Edit</button>
        <button class="danger" onclick="deletePost('${post._id}')">Delete</button>
      </div>
    `;
    list.appendChild(li);
  });
}

async function loadPosts() {
  const res = await fetch("/api/posts/manage?list=1");
  if (!res.ok) {
    showStatus("Could not load posts.", "error");
    return;
  }

  const posts = await res.json();
  allPosts = Array.isArray(posts)
    ? [...posts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
    : [];

  renderPostsList();
  renderPostEditLinkSuggestions();
}

async function editPostById(postId) {
  let post = null;

  const res = await fetch("/api/posts/manage/by-id/" + encodeURIComponent(postId));
  if (res.ok) {
    post = await res.json();
  } else {
    const listRes = await fetch("/api/posts/manage");
    if (listRes.ok) {
      const list = await listRes.json();
      if (Array.isArray(list)) {
        post = list.find(item => String(item?._id || "") === String(postId)) || null;
      }
    }
  }

  if (!post) {
    showStatus("Could not load post for editing.", "error");
    return;
  }

  await ensurePostEditor();

  editIdInput.value = post._id || "";
  editTitleInput.value = post.title || "";
  editSlugInput.value = post.slug || "";
  editCategoriesInput.value = Array.isArray(post.categories) ? post.categories.join(", ") : "";
  if (editSummaryInput) {
    editSummaryInput.value = String(post.metaDescription || post.excerpt || "").trim() || generateSummaryFromBlocks(post.content || []);
  }
  isSlugManuallyEdited = false;
  if (editModalTitle) editModalTitle.textContent = "Edit Post";
  const saveButton = document.getElementById("post-edit-save");
  if (saveButton) saveButton.textContent = "Update Post";
  if (editCancelButton) editCancelButton.textContent = "Cancel Edit";

  await postEditor.render({ blocks: Array.isArray(post.content) ? post.content : [] });
  openEditModal();
  await maybeRestorePostsEditorDraft(String(post._id || postId || ""), {
    title: post.title,
    slug: post.slug,
    categories: Array.isArray(post.categories) ? post.categories.join(", ") : "",
    metaDescription: String(post.metaDescription || post.excerpt || "").trim() || generateSummaryFromBlocks(post.content || []),
    content: Array.isArray(post.content) ? post.content : []
  });
  renderPostEditLinkSuggestions();
}

async function deletePost(id) {
  const confirmed = await window.showDeleteConfirm?.("Are you sure you want to delete this post?");
  if (!confirmed) return;

  const res = await fetch("/api/posts/" + id, { method: "DELETE" });
  if (!res.ok) {
    showStatus("Could not delete the post. Please try again.", "error");
    return;
  }

  showStatus("Post deleted.", "deleted");
  loadPosts();
}

async function openPostFromQuery() {
  const params = new URLSearchParams(window.location.search);
  const postIdToEdit = params.get("editId");
  if (!postIdToEdit) return;

  await editPostById(postIdToEdit);

  params.delete("editId");
  const nextQuery = params.toString();
  const nextUrl = nextQuery ? `${window.location.pathname}?${nextQuery}` : window.location.pathname;
  window.history.replaceState({}, "", nextUrl);
}

document.getElementById("posts-search")?.addEventListener("input", renderPostsList);

editTitleInput?.addEventListener("input", () => {
  if (!isSlugManuallyEdited) {
    editSlugInput.value = toSlug(editTitleInput.value);
  }
  renderPostEditLinkSuggestions();
  schedulePostsEditorDraftAutosave();
});

editSlugInput?.addEventListener("input", () => {
  isSlugManuallyEdited = true;
  renderPostEditLinkSuggestions();
  schedulePostsEditorDraftAutosave();
});

editCategoriesInput?.addEventListener("input", () => {
  renderPostEditLinkSuggestions();
  schedulePostsEditorDraftAutosave();
});

editSummaryInput?.addEventListener("input", () => {
  schedulePostsEditorDraftAutosave();
});

editCloseButton?.addEventListener("click", closeEditModal);
editCancelButton?.addEventListener("click", cancelEditAndDiscardDraft);

editOverlay?.addEventListener("click", event => {
  if (event.target === editOverlay) {
    closeEditModal();
  }
});

document.addEventListener("keydown", event => {
  if (event.key === "Escape" && editOverlay && !editOverlay.hidden) {
    closeEditModal();
  }
});

editForm?.addEventListener("submit", async event => {
  event.preventDefault();
  if (!postEditor) return;

  const postId = editIdInput.value;
  const isUpdate = !!postId;
  const draftContextToClear = postId || "new";

  let blocks;
  try {
    blocks = await postEditor.save();
  } catch {
    showStatus("Editor content is invalid. Please review the post content and try again.", "error");
    return;
  }
  const normalizedBlocks = normalizeImageAltInBlocks(blocks.blocks);
  const canPublish = await confirmImageAltReminder(normalizedBlocks);
  if (!canPublish) {
    showStatus("Add alt text to image blocks before publishing.", "error");
    return;
  }
  const title = editTitleInput.value.trim();
  const slug = toSlug(editSlugInput.value.trim() || title);
  editSlugInput.value = slug;
  const categories = parseCategories(editCategoriesInput.value);

  const payload = {
    title,
    slug,
    categories,
    excerpt: String(editSummaryInput?.value || "").trim() || generateSummaryFromBlocks(normalizedBlocks),
    metaDescription: String(editSummaryInput?.value || "").trim() || generateSummaryFromBlocks(normalizedBlocks),
    content: normalizedBlocks,
    published: true
  };

  const endpoint = isUpdate ? "/api/posts/" + postId : "/api/posts";
  const method = isUpdate ? "PUT" : "POST";

  const res = await fetch(endpoint, {
    method,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    const errorPayload = await res.json().catch(() => ({}));
    const fallback = isUpdate ? "Could not save post changes." : "Could not create post.";
    showStatus(errorPayload.error || fallback, "error");
    return;
  }

  removePostsDraft(draftContextToClear);
  showStatus(isUpdate ? "Post updated successfully." : "Post created successfully.", "success");
  await closeEditModal();
  await loadPosts();
});

(async function initializePage() {
  const allowed = await ensureStaffAccess();
  if (!allowed) return;
  await loadPosts();
  await openPostFromQuery();
})();
</script>

</body>
</html>
